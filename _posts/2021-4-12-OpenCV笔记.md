---
layout: post
title:  "OpenCV笔记"
date:   2021-04-12-1-24
categories: 计算机视觉
tags: OpenCV
excerpt: 学习基于Python的OpenCV的笔记
mathjax: true
---

* content
{:toc}

## 1 图像

### 1.1 读入图像

使用函数`cv2.imread()`读入图像。

第一个参数是图像路径，图像需在此程序的工作路径上或者给函数提供完整路径。第二个参数是告诉函数应该如何读取这幅图片。

- `cv2.IMREAD_COLOR`：读入一副彩色图像。图像的透明度会被忽略，这是默认参数；
- `cv2.IMREAD_GRAYSCALE`：以灰度模式读入图像；
- `cv2.IMREAD_UNCHANGED`：读入一幅图像，并且包括图像的alpha通道。

```python
import cv2

# 以灰度模式读入图像
img = cv2.imread('cat.png', cv2.IMREAD_GRAYSCALE)
print(img)
```

警告：就算图像的路径是错的，不会报错，但是当使用命令`print(img)`时得到的结果是None。

### 1.2 显示图像

使用函数`cv2.imshow()`显示图像。

窗口会自动调整为图像大小。第一个参数是窗口的名字，第二个参数是读入的图像。可以创建多个窗口，但是名字必须不同。

```python
cv2.imshow('image', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

`cv2.waitKey()`是一个键盘绑定函数。它的时间尺度是毫秒级。函数等待特定的几毫秒，看是否有键盘输入。特定的几毫秒之内，如果按下任意键，这个函数会返回按键的ASCII码值，程序将会继续运行。如果没有键盘输入，返回值为-1，如果设置这个函数的参数为0，那它将会无限期的等待键盘输入。`cv2.destroyAllWindows()`可以轻易删除任何的窗口。如果你想删除特定的窗口，可以使用`cv2.destroyWindow()`函数，在括号内输入想要删除的窗口名。

建 议：一 种 特 殊 的 情 况 ， 可 以 先 创 建 一 个 窗 口， 之 后再 加 载 图 像。 这 种 情 况 下，  可 以 决 定 窗 口 是 否 可 以 调 整大 小。 使 用 到 的 函 数 是`cv2.namedWindow()`。 初 始 设 定 函 数标 签 是`cv2.WINDOW_AUTOSIZE`。 但 是 如 果  把 标 签 改 成`cv2.WINDOW_NORMAL`，就可以调整窗口大小了。当图像维度太大，或者要添加轨迹条时，调整窗口大小将会很有用。

```python
import cv2

cv2.namedWindow('frame', cv2.WINDOW_NORMAL)
img = cv2.imread('cat.png', cv2.COLOR_BGR2GRAY)
cv2.imshow('frame', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 1.3 保存图像

使用函数`cv2.imwrite()`来保存一个图像。

第一个参赛为文件名，第二个参数是要保存的图像。

```python
cv2.imwrite('cat.jpg', img)
```

总结：

下面的程序将会加载一个灰度图，并显示图片，按下’s’键保存后退出，或者按下’q‘键退出不保存。

```python
import cv2

img = cv2.imread('cat.png', cv2.COLOR_BGR2GRAY)
cv2.imshow('frame', img)
k = cv2.waitKey(0)&0xFF
if k == ord('q'):
    cv2.destroyAllWindows()
elif k == ord('s'):
    cv2.imwrite('cat_gray.png', img)
    cv2.destroyWindow()
```

如果是32位系统，`k = cv2.waitKey(0)`即可。

## 2 视频

### 2.1 捕获视频

使用`VideoCapture`对象捕获视频。

它的参数可以是设备的索引号，或者是一个视频文件。设备索引号就是指定要使用的摄像头。一般的笔记本电脑都有内置摄像头，所以参数就是0。可以通过设置成1或者其他的来选择别的摄像头。之后就可以一帧一帧的捕获视频。

```python
import cv2

cap = cv2.VideoCapture(0)
while True:
    ret, frame = cap.read()
    cv2.imshow('frame', frame)
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
```

`cap.read()`返回一个布尔值（True/False）。如果帧读取的是正确的，则返回True。所以可以通过检查它的返回值来查看视频文件是否已经到了结尾。有时cap可能不能成功的初始化摄像头设备。这种情况下上面的代码会报错。可以使用`cap.isOpened()`来检查是否成功初始化了。如果返回值是True，那就没有问题，否则就要使用函数`cap.open()`。

可以使用函数`cap.get(propId)`来获得视频的一些参数信息。`propId`参数可以是0到18之间的任何整数。每一个数代表视频的一个属性，其中的一些值可以使用`cap.set(propId, value)`来修改，value就是想要设置成的新值。例如，使用`cap.get(3)`和`cap.get(4)`来查看每一帧的宽和高。默认情况下得到的值是`640X480`。但是可以使用`ret=cap.set(3,320)`和`ret=cap.set(4,240)`来把宽和高改成`320X240`。

0. `CV_CAP_PROP_POS_MSEC` Current position of the video filein milliseconds.
1. `CV_CAP_PROP_POS_FRAMES`0-based index of the frame tobe decoded/captured next.
2. `CV_CAP_PROP_POS_AVI_RATIO`Relative position of thevideo file: 0 - start of the film, 1 - end of the film.
3. `CV_CAP_PROP_FRAME_WIDTH`Width of the frames in thevideo stream.
4. `CV_CAP_PROP_FRAME_HEIGHT`Height of the frames in thevideo stream.
5. `CV_CAP_PROP_FPS`Frame rate.
6. `CV_CAP_PROP_FOURCC`4-character code of codec.
7. `CV_CAP_PROP_FRAME_COUNT`Number of frames in thevideo file.
8. `CV_CAP_PROP_FORMAT`Format of the Mat objects returnedby retrieve()
9. `CV_CAP_PROP_MODE`Backend-specific value indicating thecurrent capture mode.
10. `CV_CAP_PROP_BRIGHTNESS`Brightness of the image (onlyfor cameras).
11. `CV_CAP_PROP_CONTRAST`Contrast of the image (only forcameras).
12. `CV_CAP_PROP_SATURATION`Saturation of the image (onlyfor cameras).
13. `CV_CAP_PROP_HUE` Hueof the image (only for cameras).
14. `CV_CAP_PROP_GAIN`Gain of the image (only for cameras).
15. `CV_CAP_PROP_EXPOSURE`Exposure (only for cameras).
16. `CV_CAP_PROP_CONVERT_RGB`Boolean flags indicatingwhether images should be converted to RGB.
17. `CV_CAP_PROP_WHITE_BALANCE`Currently unsupported
18. `CV_CAP_PROP_RECTIFICATION`Rectification flag for stereocameras (note: only supported by DC1394 v 2.x backend cur-rently)

### 2.2 播放视频

与从摄像头中捕获一样，只需要把设备索引号改成视频文件的名字。在播放每一帧时，使用`cv2.waiKey()`设置适当的持续时间。如果设置的太低视频就会播放的非常快，如果设置的太高就会播放的很慢（可以使用这种方法控制视频的播放速度）。通常情况下25毫秒就可以了。

### 2.3 保存视频

使用`VideoWriter`对象保存视频。

第一个参数为输出文件的名字，第二个参数指定`FourCC`编码，第三个参数为播放频率，第四个参数为帧的大小，第五个参数是`isColor`标签。标签如果是True，每一帧就是彩色图，否则就是灰度图。

`FourCC`是一个4字节码，用来确定视频的编码格式。可用的编码列表可以从https://www.fourcc.org/查到，这是平台依赖的。`FourCC`码以下面的格式传给程序，以`MJPG`为例：`cv2.VideoWriter_fourcc('M','J','P','G')`或者`cv2.VideoWriter_fourcc(*'MJPG')`。

下面的代码是从摄像头中捕获视频，沿水平方向旋转每一帧并保存它。

```python
import cv2

cap = cv2.VideoCapture(0)
fourcc = cv2.VideoWriter_fourcc('m', 'p', '4', 'v')
out = cv2.VideoWriter('output.mp4', fourcc, 20.0, (640, 480))
while cap.isOpened():
    ret, frame = cap.read()
    if ret:
        frame = cv2.flip(frame, 0)
        out.write(frame)
        cv2.imshow('frame', frame)
        if cv2.waitKey(1) & 0xff == ord('q'):
            break
    else:
        break

cap.release()
out.release()
cv2.destroyAllWindows()
```

